<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>为什么要服务端渲染（ssr） | 前端随笔 FE-Essay</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="记录前端重要知识点和遇到的好文章，同时还有前端重要算法知识，但最关键的是包含各大小厂真题。">
    
    <link rel="preload" href="/FE-Essay/assets/css/0.styles.800aef37.css" as="style"><link rel="preload" href="/FE-Essay/assets/js/app.d894750d.js" as="script"><link rel="preload" href="/FE-Essay/assets/js/2.6f24bad2.js" as="script"><link rel="preload" href="/FE-Essay/assets/js/138.071df325.js" as="script"><link rel="prefetch" href="/FE-Essay/assets/js/10.5a2fde20.js"><link rel="prefetch" href="/FE-Essay/assets/js/100.9594eafa.js"><link rel="prefetch" href="/FE-Essay/assets/js/101.614e591f.js"><link rel="prefetch" href="/FE-Essay/assets/js/102.0041d53e.js"><link rel="prefetch" href="/FE-Essay/assets/js/103.1dff9470.js"><link rel="prefetch" href="/FE-Essay/assets/js/104.af30473f.js"><link rel="prefetch" href="/FE-Essay/assets/js/105.f02b791b.js"><link rel="prefetch" href="/FE-Essay/assets/js/106.a7fcd281.js"><link rel="prefetch" href="/FE-Essay/assets/js/107.32ab4370.js"><link rel="prefetch" href="/FE-Essay/assets/js/108.202f64c3.js"><link rel="prefetch" href="/FE-Essay/assets/js/109.b5e0bb34.js"><link rel="prefetch" href="/FE-Essay/assets/js/11.35e672e7.js"><link rel="prefetch" href="/FE-Essay/assets/js/110.11155497.js"><link rel="prefetch" href="/FE-Essay/assets/js/111.72b5c8b8.js"><link rel="prefetch" href="/FE-Essay/assets/js/112.51d8327e.js"><link rel="prefetch" href="/FE-Essay/assets/js/113.d25e4af0.js"><link rel="prefetch" href="/FE-Essay/assets/js/114.4f1e3c16.js"><link rel="prefetch" href="/FE-Essay/assets/js/115.4bb153e7.js"><link rel="prefetch" href="/FE-Essay/assets/js/116.15192a7b.js"><link rel="prefetch" href="/FE-Essay/assets/js/117.34197e48.js"><link rel="prefetch" href="/FE-Essay/assets/js/118.6072b0cd.js"><link rel="prefetch" href="/FE-Essay/assets/js/119.ec1f5c2d.js"><link rel="prefetch" href="/FE-Essay/assets/js/12.4fee18de.js"><link rel="prefetch" href="/FE-Essay/assets/js/120.15811c4f.js"><link rel="prefetch" href="/FE-Essay/assets/js/121.03e8cf49.js"><link rel="prefetch" href="/FE-Essay/assets/js/122.4e151da3.js"><link rel="prefetch" href="/FE-Essay/assets/js/123.e961a61d.js"><link rel="prefetch" href="/FE-Essay/assets/js/124.cd719944.js"><link rel="prefetch" href="/FE-Essay/assets/js/125.8fa005d5.js"><link rel="prefetch" href="/FE-Essay/assets/js/126.1382d4ee.js"><link rel="prefetch" href="/FE-Essay/assets/js/127.4db9b245.js"><link rel="prefetch" href="/FE-Essay/assets/js/128.a8e1e871.js"><link rel="prefetch" href="/FE-Essay/assets/js/129.71b0f095.js"><link rel="prefetch" href="/FE-Essay/assets/js/13.b32cfeb3.js"><link rel="prefetch" href="/FE-Essay/assets/js/130.962935e7.js"><link rel="prefetch" href="/FE-Essay/assets/js/131.8d813403.js"><link rel="prefetch" href="/FE-Essay/assets/js/132.b54be6e6.js"><link rel="prefetch" href="/FE-Essay/assets/js/133.9e5ef1c0.js"><link rel="prefetch" href="/FE-Essay/assets/js/134.b8f38957.js"><link rel="prefetch" href="/FE-Essay/assets/js/135.c726626f.js"><link rel="prefetch" href="/FE-Essay/assets/js/136.7bdd8be5.js"><link rel="prefetch" href="/FE-Essay/assets/js/137.806cb407.js"><link rel="prefetch" href="/FE-Essay/assets/js/139.5ef9c663.js"><link rel="prefetch" href="/FE-Essay/assets/js/14.a6e92871.js"><link rel="prefetch" href="/FE-Essay/assets/js/140.f65798f2.js"><link rel="prefetch" href="/FE-Essay/assets/js/141.8b87ab04.js"><link rel="prefetch" href="/FE-Essay/assets/js/142.14a3f09d.js"><link rel="prefetch" href="/FE-Essay/assets/js/143.d603fa4b.js"><link rel="prefetch" href="/FE-Essay/assets/js/144.da9f8a8b.js"><link rel="prefetch" href="/FE-Essay/assets/js/145.a4437f5f.js"><link rel="prefetch" href="/FE-Essay/assets/js/146.cfc19753.js"><link rel="prefetch" href="/FE-Essay/assets/js/147.33fdd9d9.js"><link rel="prefetch" href="/FE-Essay/assets/js/148.675d376b.js"><link rel="prefetch" href="/FE-Essay/assets/js/149.ebd8163c.js"><link rel="prefetch" href="/FE-Essay/assets/js/15.ea904118.js"><link rel="prefetch" href="/FE-Essay/assets/js/150.ad8345fd.js"><link rel="prefetch" href="/FE-Essay/assets/js/151.23f6c0c9.js"><link rel="prefetch" href="/FE-Essay/assets/js/152.7775d288.js"><link rel="prefetch" href="/FE-Essay/assets/js/153.ee946d7d.js"><link rel="prefetch" href="/FE-Essay/assets/js/154.7b439f90.js"><link rel="prefetch" href="/FE-Essay/assets/js/155.41e1b55e.js"><link rel="prefetch" href="/FE-Essay/assets/js/156.6b91f3df.js"><link rel="prefetch" href="/FE-Essay/assets/js/157.5ca3faeb.js"><link rel="prefetch" href="/FE-Essay/assets/js/158.734c75bb.js"><link rel="prefetch" href="/FE-Essay/assets/js/159.1a6fac05.js"><link rel="prefetch" href="/FE-Essay/assets/js/16.c50f9b3b.js"><link rel="prefetch" href="/FE-Essay/assets/js/160.2b2183c5.js"><link rel="prefetch" href="/FE-Essay/assets/js/161.b760e5ce.js"><link rel="prefetch" href="/FE-Essay/assets/js/162.b33ee3c2.js"><link rel="prefetch" href="/FE-Essay/assets/js/163.67753a52.js"><link rel="prefetch" href="/FE-Essay/assets/js/164.bb75d285.js"><link rel="prefetch" href="/FE-Essay/assets/js/165.1dcd9af1.js"><link rel="prefetch" href="/FE-Essay/assets/js/166.0a301ac6.js"><link rel="prefetch" href="/FE-Essay/assets/js/167.af13d0c3.js"><link rel="prefetch" href="/FE-Essay/assets/js/168.fe19b839.js"><link rel="prefetch" href="/FE-Essay/assets/js/169.d9a0650d.js"><link rel="prefetch" href="/FE-Essay/assets/js/17.fdc721ee.js"><link rel="prefetch" href="/FE-Essay/assets/js/170.d8ffde4b.js"><link rel="prefetch" href="/FE-Essay/assets/js/171.22294491.js"><link rel="prefetch" href="/FE-Essay/assets/js/172.70795179.js"><link rel="prefetch" href="/FE-Essay/assets/js/173.08afa17a.js"><link rel="prefetch" href="/FE-Essay/assets/js/174.09a6ae2c.js"><link rel="prefetch" href="/FE-Essay/assets/js/175.ec76ad6f.js"><link rel="prefetch" href="/FE-Essay/assets/js/176.cc99829a.js"><link rel="prefetch" href="/FE-Essay/assets/js/177.be49327b.js"><link rel="prefetch" href="/FE-Essay/assets/js/178.aa30303c.js"><link rel="prefetch" href="/FE-Essay/assets/js/179.b7c916bc.js"><link rel="prefetch" href="/FE-Essay/assets/js/18.6ad16c34.js"><link rel="prefetch" href="/FE-Essay/assets/js/180.08ef709e.js"><link rel="prefetch" href="/FE-Essay/assets/js/181.7b864e06.js"><link rel="prefetch" href="/FE-Essay/assets/js/182.e6f8beae.js"><link rel="prefetch" href="/FE-Essay/assets/js/183.d944ff35.js"><link rel="prefetch" href="/FE-Essay/assets/js/184.8a3a3a2c.js"><link rel="prefetch" href="/FE-Essay/assets/js/185.111d6b65.js"><link rel="prefetch" href="/FE-Essay/assets/js/186.49a0c3b7.js"><link rel="prefetch" href="/FE-Essay/assets/js/187.959df99d.js"><link rel="prefetch" href="/FE-Essay/assets/js/188.7818291e.js"><link rel="prefetch" href="/FE-Essay/assets/js/189.71ebf2ba.js"><link rel="prefetch" href="/FE-Essay/assets/js/19.62a10c8d.js"><link rel="prefetch" href="/FE-Essay/assets/js/190.02286ad7.js"><link rel="prefetch" href="/FE-Essay/assets/js/191.6b09bf18.js"><link rel="prefetch" href="/FE-Essay/assets/js/192.4b8f2fe9.js"><link rel="prefetch" href="/FE-Essay/assets/js/193.cd5ccd32.js"><link rel="prefetch" href="/FE-Essay/assets/js/194.a177878b.js"><link rel="prefetch" href="/FE-Essay/assets/js/195.b14a94a9.js"><link rel="prefetch" href="/FE-Essay/assets/js/196.0c207a50.js"><link rel="prefetch" href="/FE-Essay/assets/js/197.da675dad.js"><link rel="prefetch" href="/FE-Essay/assets/js/198.b9e76abe.js"><link rel="prefetch" href="/FE-Essay/assets/js/199.6a35283d.js"><link rel="prefetch" href="/FE-Essay/assets/js/20.6010101c.js"><link rel="prefetch" href="/FE-Essay/assets/js/200.0043face.js"><link rel="prefetch" href="/FE-Essay/assets/js/201.206846bb.js"><link rel="prefetch" href="/FE-Essay/assets/js/202.d57c1c77.js"><link rel="prefetch" href="/FE-Essay/assets/js/203.850c1dbc.js"><link rel="prefetch" href="/FE-Essay/assets/js/204.3c7307c5.js"><link rel="prefetch" href="/FE-Essay/assets/js/205.81f03914.js"><link rel="prefetch" href="/FE-Essay/assets/js/206.1349419a.js"><link rel="prefetch" href="/FE-Essay/assets/js/207.c17ffd94.js"><link rel="prefetch" href="/FE-Essay/assets/js/208.54e10f4f.js"><link rel="prefetch" href="/FE-Essay/assets/js/209.59a32b2e.js"><link rel="prefetch" href="/FE-Essay/assets/js/21.78b1499c.js"><link rel="prefetch" href="/FE-Essay/assets/js/210.0fa5b478.js"><link rel="prefetch" href="/FE-Essay/assets/js/211.986c49c6.js"><link rel="prefetch" href="/FE-Essay/assets/js/212.ac706b31.js"><link rel="prefetch" href="/FE-Essay/assets/js/213.b2ad8c64.js"><link rel="prefetch" href="/FE-Essay/assets/js/214.f8a0485b.js"><link rel="prefetch" href="/FE-Essay/assets/js/215.1dffaf5f.js"><link rel="prefetch" href="/FE-Essay/assets/js/216.a4ad565d.js"><link rel="prefetch" href="/FE-Essay/assets/js/217.6bf16809.js"><link rel="prefetch" href="/FE-Essay/assets/js/218.dee44f2d.js"><link rel="prefetch" href="/FE-Essay/assets/js/219.69097b61.js"><link rel="prefetch" href="/FE-Essay/assets/js/22.6012803f.js"><link rel="prefetch" href="/FE-Essay/assets/js/220.4679fece.js"><link rel="prefetch" href="/FE-Essay/assets/js/221.4d03bff9.js"><link rel="prefetch" href="/FE-Essay/assets/js/222.4af79a16.js"><link rel="prefetch" href="/FE-Essay/assets/js/223.c2778721.js"><link rel="prefetch" href="/FE-Essay/assets/js/224.bb979184.js"><link rel="prefetch" href="/FE-Essay/assets/js/225.db3650d2.js"><link rel="prefetch" href="/FE-Essay/assets/js/226.36c93f6e.js"><link rel="prefetch" href="/FE-Essay/assets/js/227.fbf88dda.js"><link rel="prefetch" href="/FE-Essay/assets/js/228.d6c1056a.js"><link rel="prefetch" href="/FE-Essay/assets/js/229.ad23908c.js"><link rel="prefetch" href="/FE-Essay/assets/js/23.7a61848c.js"><link rel="prefetch" href="/FE-Essay/assets/js/230.f067d87f.js"><link rel="prefetch" href="/FE-Essay/assets/js/231.c51dc3a3.js"><link rel="prefetch" href="/FE-Essay/assets/js/232.e27cea07.js"><link rel="prefetch" href="/FE-Essay/assets/js/233.85f9db04.js"><link rel="prefetch" href="/FE-Essay/assets/js/234.02c9802b.js"><link rel="prefetch" href="/FE-Essay/assets/js/235.e4a967c4.js"><link rel="prefetch" href="/FE-Essay/assets/js/236.c5a6cb9d.js"><link rel="prefetch" href="/FE-Essay/assets/js/237.576a0d95.js"><link rel="prefetch" href="/FE-Essay/assets/js/238.41549eee.js"><link rel="prefetch" href="/FE-Essay/assets/js/239.cdf8240b.js"><link rel="prefetch" href="/FE-Essay/assets/js/24.b84f691c.js"><link rel="prefetch" href="/FE-Essay/assets/js/240.fdb7236c.js"><link rel="prefetch" href="/FE-Essay/assets/js/241.c5b64c0e.js"><link rel="prefetch" href="/FE-Essay/assets/js/242.8773b762.js"><link rel="prefetch" href="/FE-Essay/assets/js/243.1322295c.js"><link rel="prefetch" href="/FE-Essay/assets/js/244.fb6d7667.js"><link rel="prefetch" href="/FE-Essay/assets/js/245.7607eab4.js"><link rel="prefetch" href="/FE-Essay/assets/js/246.2b46ac59.js"><link rel="prefetch" href="/FE-Essay/assets/js/247.0bc62796.js"><link rel="prefetch" href="/FE-Essay/assets/js/248.4782caf7.js"><link rel="prefetch" href="/FE-Essay/assets/js/25.341a26ca.js"><link rel="prefetch" href="/FE-Essay/assets/js/26.54ca7b75.js"><link rel="prefetch" href="/FE-Essay/assets/js/27.b01cae52.js"><link rel="prefetch" href="/FE-Essay/assets/js/28.c135019e.js"><link rel="prefetch" href="/FE-Essay/assets/js/29.98caf4e6.js"><link rel="prefetch" href="/FE-Essay/assets/js/3.04e35d2f.js"><link rel="prefetch" href="/FE-Essay/assets/js/30.1b96d408.js"><link rel="prefetch" href="/FE-Essay/assets/js/31.c81fe3b1.js"><link rel="prefetch" href="/FE-Essay/assets/js/32.d7d4b567.js"><link rel="prefetch" href="/FE-Essay/assets/js/33.b93dbe36.js"><link rel="prefetch" href="/FE-Essay/assets/js/34.d4028efd.js"><link rel="prefetch" href="/FE-Essay/assets/js/35.c425dc4a.js"><link rel="prefetch" href="/FE-Essay/assets/js/36.96c7fe27.js"><link rel="prefetch" href="/FE-Essay/assets/js/37.c6b5ef12.js"><link rel="prefetch" href="/FE-Essay/assets/js/38.c00b50fd.js"><link rel="prefetch" href="/FE-Essay/assets/js/39.55455f47.js"><link rel="prefetch" href="/FE-Essay/assets/js/4.e0652429.js"><link rel="prefetch" href="/FE-Essay/assets/js/40.f43f584e.js"><link rel="prefetch" href="/FE-Essay/assets/js/41.2ea51bbd.js"><link rel="prefetch" href="/FE-Essay/assets/js/42.816d1cd7.js"><link rel="prefetch" href="/FE-Essay/assets/js/43.d093122e.js"><link rel="prefetch" href="/FE-Essay/assets/js/44.30b16e1a.js"><link rel="prefetch" href="/FE-Essay/assets/js/45.8b0e0034.js"><link rel="prefetch" href="/FE-Essay/assets/js/46.4bdf9113.js"><link rel="prefetch" href="/FE-Essay/assets/js/47.3d6a8b30.js"><link rel="prefetch" href="/FE-Essay/assets/js/48.5f4c9bc4.js"><link rel="prefetch" href="/FE-Essay/assets/js/49.8c32e546.js"><link rel="prefetch" href="/FE-Essay/assets/js/5.62a68b3b.js"><link rel="prefetch" href="/FE-Essay/assets/js/50.7ec25a27.js"><link rel="prefetch" href="/FE-Essay/assets/js/51.6077efdd.js"><link rel="prefetch" href="/FE-Essay/assets/js/52.df36784e.js"><link rel="prefetch" href="/FE-Essay/assets/js/53.7b517edb.js"><link rel="prefetch" href="/FE-Essay/assets/js/54.9d9e7db0.js"><link rel="prefetch" href="/FE-Essay/assets/js/55.c96f50ab.js"><link rel="prefetch" href="/FE-Essay/assets/js/56.9238cb49.js"><link rel="prefetch" href="/FE-Essay/assets/js/57.12f8a3ef.js"><link rel="prefetch" href="/FE-Essay/assets/js/58.bea0a1c2.js"><link rel="prefetch" href="/FE-Essay/assets/js/59.6a589ffd.js"><link rel="prefetch" href="/FE-Essay/assets/js/6.2cc0afe6.js"><link rel="prefetch" href="/FE-Essay/assets/js/60.0b9f7056.js"><link rel="prefetch" href="/FE-Essay/assets/js/61.41ea5f57.js"><link rel="prefetch" href="/FE-Essay/assets/js/62.58c70a1f.js"><link rel="prefetch" href="/FE-Essay/assets/js/63.8b6c3e58.js"><link rel="prefetch" href="/FE-Essay/assets/js/64.2e78d5f4.js"><link rel="prefetch" href="/FE-Essay/assets/js/65.3e50b1cf.js"><link rel="prefetch" href="/FE-Essay/assets/js/66.fe10a117.js"><link rel="prefetch" href="/FE-Essay/assets/js/67.92f90928.js"><link rel="prefetch" href="/FE-Essay/assets/js/68.41dc1212.js"><link rel="prefetch" href="/FE-Essay/assets/js/69.f92969a9.js"><link rel="prefetch" href="/FE-Essay/assets/js/7.bd5fb70f.js"><link rel="prefetch" href="/FE-Essay/assets/js/70.79942ec5.js"><link rel="prefetch" href="/FE-Essay/assets/js/71.e4436162.js"><link rel="prefetch" href="/FE-Essay/assets/js/72.c21541e3.js"><link rel="prefetch" href="/FE-Essay/assets/js/73.5411777b.js"><link rel="prefetch" href="/FE-Essay/assets/js/74.7829bafb.js"><link rel="prefetch" href="/FE-Essay/assets/js/75.106f2a60.js"><link rel="prefetch" href="/FE-Essay/assets/js/76.e14926fa.js"><link rel="prefetch" href="/FE-Essay/assets/js/77.f103ad44.js"><link rel="prefetch" href="/FE-Essay/assets/js/78.a893678d.js"><link rel="prefetch" href="/FE-Essay/assets/js/79.1d1fafa3.js"><link rel="prefetch" href="/FE-Essay/assets/js/8.3d6e4a4c.js"><link rel="prefetch" href="/FE-Essay/assets/js/80.489d25ab.js"><link rel="prefetch" href="/FE-Essay/assets/js/81.e9bcea5a.js"><link rel="prefetch" href="/FE-Essay/assets/js/82.b5a25889.js"><link rel="prefetch" href="/FE-Essay/assets/js/83.907121af.js"><link rel="prefetch" href="/FE-Essay/assets/js/84.d1f703f6.js"><link rel="prefetch" href="/FE-Essay/assets/js/85.3aec9bfd.js"><link rel="prefetch" href="/FE-Essay/assets/js/86.7fc89368.js"><link rel="prefetch" href="/FE-Essay/assets/js/87.158c2319.js"><link rel="prefetch" href="/FE-Essay/assets/js/88.9de9b995.js"><link rel="prefetch" href="/FE-Essay/assets/js/89.b0e0312a.js"><link rel="prefetch" href="/FE-Essay/assets/js/9.035f1bd2.js"><link rel="prefetch" href="/FE-Essay/assets/js/90.3221cf42.js"><link rel="prefetch" href="/FE-Essay/assets/js/91.21f051ae.js"><link rel="prefetch" href="/FE-Essay/assets/js/92.2783ec6e.js"><link rel="prefetch" href="/FE-Essay/assets/js/93.7c14fb90.js"><link rel="prefetch" href="/FE-Essay/assets/js/94.7286edab.js"><link rel="prefetch" href="/FE-Essay/assets/js/95.972d227a.js"><link rel="prefetch" href="/FE-Essay/assets/js/96.49dedf29.js"><link rel="prefetch" href="/FE-Essay/assets/js/97.14dbbf5e.js"><link rel="prefetch" href="/FE-Essay/assets/js/98.03edfb81.js"><link rel="prefetch" href="/FE-Essay/assets/js/99.b8a51908.js">
    <link rel="stylesheet" href="/FE-Essay/assets/css/0.styles.800aef37.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/FE-Essay/" class="home-link router-link-active"><!----> <span class="site-name">前端随笔 FE-Essay</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/i-want-offer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/i-want-offer" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/FE-Essay/" aria-current="page" class="sidebar-link">README.md</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前后端通信</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实践篇</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>手写代码</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>框架</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/FE-Essay/框架/AST.html" class="sidebar-link">AST.md</a></li><li><a href="/FE-Essay/框架/IoC和DI.html" class="sidebar-link">IoC和DI.md</a></li><li><a href="/FE-Essay/框架/Libuv.html" class="sidebar-link">Libuv.md</a></li><li><a href="/FE-Essay/框架/Proxy相比较于defineProperty的优势.html" class="sidebar-link">Proxy相比较于defineProperty的优势.md</a></li><li><a href="/FE-Essay/框架/React-Fiber架构.html" class="sidebar-link">React-Fiber架构.md</a></li><li><a href="/FE-Essay/框架/React-Hook原理剖析.html" class="sidebar-link">React-Hook原理剖析.md</a></li><li><a href="/FE-Essay/框架/React事件机制.html" class="sidebar-link">React事件机制.md</a></li><li><a href="/FE-Essay/框架/React事件机制原理.html" class="sidebar-link">React事件机制原理.md</a></li><li><a href="/FE-Essay/框架/React常见题目.html" class="sidebar-link">React常见题目.md</a></li><li><a href="/FE-Essay/框架/Virtual-DOM.html" class="sidebar-link">Virtual-DOM.md</a></li><li><a href="/FE-Essay/框架/Vue和React的区别.html" class="sidebar-link">Vue和React的区别.md</a></li><li><a href="/FE-Essay/框架/babel知识点.html" class="sidebar-link">babel知识点.md</a></li><li><a href="/FE-Essay/框架/graphql.html" class="sidebar-link">graphql.md</a></li><li><a href="/FE-Essay/框架/mobx和redux.html" class="sidebar-link">mobx和redux.md</a></li><li><a href="/FE-Essay/框架/react-router原理.html" class="sidebar-link">react-router原理.md</a></li><li><a href="/FE-Essay/框架/vue知识点.html" class="sidebar-link">vue知识点.md</a></li><li><a href="/FE-Essay/框架/了解Angular-Ivy：Incremental-DOM 和Virtual-DOM.html" class="sidebar-link">了解Angular-Ivy：Incremental-DOM 和Virtual-DOM.md</a></li><li><a href="/FE-Essay/框架/什么是多态.html" class="sidebar-link">什么是多态.md</a></li><li><a href="/FE-Essay/框架/服务端渲染原理.html" class="active sidebar-link">服务端渲染原理.md</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#首屏等待" class="sidebar-link">首屏等待</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#seo" class="sidebar-link">SEO</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#从-ejs-开始" class="sidebar-link">从 ejs 开始</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#jsx-到字符串" class="sidebar-link">JSX 到字符串</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#双端路由如何维护" class="sidebar-link">双端路由如何维护？</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#获取数据的方法和逻辑写在哪里" class="sidebar-link">获取数据的方法和逻辑写在哪里？</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#服务端-html-节点无法重用" class="sidebar-link">服务端 html 节点无法重用</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#路由同构" class="sidebar-link">路由同构</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#数据同构-预取同构" class="sidebar-link">数据同构（预取同构）</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#渲染同构" class="sidebar-link">渲染同构</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#如何实现组件的按需加载" class="sidebar-link">如何实现组件的按需加载？</a></li><li class="sidebar-sub-header"><a href="/FE-Essay/框架/服务端渲染原理.html#动态路由-ssr-双端配置" class="sidebar-link">动态路由 SSR 双端配置</a></li></ul></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>深入react技术栈</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/FE-Essay/框架/深入了解Angular变更检查.html" class="sidebar-link">深入了解Angular变更检查.md</a></li><li><a href="/FE-Essay/框架/深入理解洋葱模型中间件机制.html" class="sidebar-link">深入理解洋葱模型中间件机制.md</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>模块化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器渲染</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>真题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>错误监控</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="为什么要服务端渲染-ssr"><a href="#为什么要服务端渲染-ssr" class="header-anchor">#</a> 为什么要服务端渲染（ssr）</h1> <h2 id="首屏等待"><a href="#首屏等待" class="header-anchor">#</a> 首屏等待</h2> <p>在 SPA 模式下，所有的数据请求和 DOM 渲染都在浏览器端完成，所以当我们第一次访问页面的时候很可能会存在“白屏”等待，而服务端渲染所有数据和 html 内容已在服务端处理完成，浏览器收到的是完整的 html 内容，可以更快地看到渲染内容，在服务端完成数据请求肯定要比浏览器端效率高得多。</p> <h2 id="seo"><a href="#seo" class="header-anchor">#</a> SEO</h2> <p>SPA 由于加载模版的时候页面骨架上面只有一个节点，其余所有节点都是由 JS 动态生成的，因为搜索引擎爬虫只认识 html 结构的内容，不能识别 JS 代码内容，所以对于 SEO，完全无能为力。</p> <h1 id="核心原理"><a href="#核心原理" class="header-anchor">#</a> 核心原理</h1> <p>整体来说服务端渲染原理不复杂，核心内容就是同构。</p> <p>node server 接收到客户端请求，得到当前的 req url path，然后在已有的路有列表内查找对应的组件，拿到需要请求去的数据，将数据作为 props、context 或者 store 形式存入组件，然后基于 react 内置的服务端渲染 api <code>renderToString</code> 或者 <code>renderToNodeStream</code> 把组件渲染为 html字符串 或者 stream流，在把最终的 html 进行输出前需要将数据注入到浏览器端（注水），server 输出（response）后浏览器可以得到数据（脱水），浏览器开始进行渲染和节点比对，然后执行组件的 componentDidMount 完成组件内事件绑定和一些交互，浏览器重用了服务端输出的 html节点，整个流程结束。</p> <p><img src="https://segmentfault.com/img/remote/1460000021980719" alt="服务端渲染架构图"></p> <h1 id="react-ssr"><a href="#react-ssr" class="header-anchor">#</a> React SSR</h1> <h2 id="从-ejs-开始"><a href="#从-ejs-开始" class="header-anchor">#</a> 从 ejs 开始</h2> <blockquote><p>实现 ssr 很简单，先看一个 node ejs 的例子</p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- index.html --&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>&lt;%= title %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
		&lt;%= data %&gt;
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// node ssr</span>
<span class="token keyword">const</span> ejs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ejs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rea<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span><span class="token string">'./views/index.ejs'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      title<span class="token operator">:</span> <span class="token string">'react ssr'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> <span class="token string">'首页'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token keyword">else</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="jsx-到字符串"><a href="#jsx-到字符串" class="header-anchor">#</a> JSX 到字符串</h2> <p>参考上面，我们使用 React 组建来实现服务端渲染，使用 jsx 来代替 ejs。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">const</span> React <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> renderToString <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react-dom/server'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token comment">// 组件</span>
<span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>data<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 模拟数据获取</span>
<span class="token keyword">const</span> <span class="token function-variable function">fetch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'react ssr'</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Index</span></span> <span class="token attr-name">data</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p><strong>ps</strong>：以上代码不能直接运行，需要结合 babel 使用 @babel/preset-react 进行转换</p></blockquote> <h1 id="关键问题"><a href="#关键问题" class="header-anchor">#</a> 关键问题</h1> <p>在上面非常简单的就实现了 react ssr，它帮助我们引出了一系列关键问题：</p> <h2 id="双端路由如何维护"><a href="#双端路由如何维护" class="header-anchor">#</a> 双端路由如何维护？</h2> <p>首先我们会发现我在 server 端定义了路由 '/'，但是在 react SPA 模式下我们需要使用 react-router 来定义路由，那是不是需要维护两套路由？</p> <h2 id="获取数据的方法和逻辑写在哪里"><a href="#获取数据的方法和逻辑写在哪里" class="header-anchor">#</a> 获取数据的方法和逻辑写在哪里？</h2> <p>我们发现获取数据的 fetch 方法是独立的，和组件没有任何关联，我们更希望每个路由组件都有自己的 fetch 方法。</p> <h2 id="服务端-html-节点无法重用"><a href="#服务端-html-节点无法重用" class="header-anchor">#</a> 服务端 html 节点无法重用</h2> <p>虽然组件在服务端得到了数据，也能渲染到浏览器内，但是当浏览器端进行组件渲染的时候，直出的内容会一闪而过消失。</p> <h1 id="同构才是核心"><a href="#同构才是核心" class="header-anchor">#</a> 同构才是核心</h1> <p>react ssr 的核心就是同构，没有同构的 ssr 是没有意义的。</p> <p>所谓同构就是采用一套代码，构建双端（server 和 client）逻辑，最大限度的重用代码，不用维护两套代码。而传统的服务端渲染无法做到，react ssr 的出现打破了这个瓶颈，并且已经得到了比较广泛的应用。</p> <h2 id="路由同构"><a href="#路由同构" class="header-anchor">#</a> 路由同构</h2> <p>双端使用同一套路由规则，node server 通过 req url path 进行组件查找，得到需要渲染的组件。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 组件和路由配置，供双端使用 routes-config.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">class</span> <span class="token class-name">Detail</span> <span class="token keyword">from</span> React<span class="token punctuation">.</span>Component <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">detail</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">from</span> React<span class="token punctuation">.</span>Component <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">index</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    exact<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> Home
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/detail'</span><span class="token punctuation">,</span>
    exact<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> Detail
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/detail/:a/:b'</span><span class="token punctuation">,</span>
    exact<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> Detail
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> routes
</code></pre></div><div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 客户端路由组件</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'./routes-config.js'</span>

<span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Layout</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  	</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Switch</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    	</span><span class="token punctuation">{</span>routes<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Route</span></span> 
                 <span class="token attr-name">path</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>path<span class="token punctuation">}</span></span> 
                 <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span></span> 
                 <span class="token attr-name">exact</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>exact<span class="token punctuation">}</span></span>
                 <span class="token attr-name">render</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>component<span class="token punctuation">}</span></span>
                 <span class="token punctuation">/&gt;</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Switch</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Layout</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> App
</code></pre></div><p><strong>node server</strong> 进行组件查找</p> <p>路由匹配其实就是对组件 path 规则的匹配，如果规则不复杂可以自己写，如果情况很多种还是使用官方提供的库来完成。</p> <p><code>matchRoutes(routes, pathname)</code></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> matchRoutes <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-config'</span>
<span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'./routes-config.js'</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
  <span class="token comment">// 简单排出图片等资源文件的请求</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 查找组件</span>
  <span class="token keyword">const</span> branch <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  <span class="token comment">// 得到组件</span>
  <span class="token keyword">const</span> Component <span class="token operator">=</span> branch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>route<span class="token punctuation">.</span>component
  <span class="token comment">// 将组件渲染为 html 字符串</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token attr-name">data</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
  
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p><code>matchRoutes</code> 具体返回值查看官方文档</p></blockquote> <h2 id="数据同构-预取同构"><a href="#数据同构-预取同构" class="header-anchor">#</a> 数据同构（预取同构）</h2> <blockquote><p>这里我们解决【获取数据的方法和逻辑放在哪里？】</p></blockquote> <p>数据预取同构，解决双端如何使用同一套数据请求方法来进行数据请求。</p> <p>在查找到要渲染的组件后，需要预先得到此组件所需要的数据，然后将数据传递给组件后，再进行组件的渲染。</p> <p>我们可以通过给组件定义静态方法来处理，组件内定义异步数据请求的方法也合情合理，同时声明为 static，在服务端和组件内部都可以通过组件来进行访问，比如：<code>Index.getInitialProps</code></p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 组件</span>
<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getInitialProps</span><span class="token punctuation">(</span><span class="token parameter">opt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fetch1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/xxx.com/a'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> fetch2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/xxx.com/b'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      res<span class="token operator">:</span> <span class="token punctuation">[</span>fetch1<span class="token punctuation">,</span> fetch2<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>data<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 服务端</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
  <span class="token keyword">if</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 组件查找</span>
  <span class="token keyword">const</span> branch <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  <span class="token comment">// 得到组件</span>
  <span class="token keyword">const</span> Component <span class="token operator">=</span> branch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>route<span class="token punctuation">.</span>component
  <span class="token comment">// 数据获取</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> Component<span class="token punctuation">.</span><span class="token function">getinitialProps</span><span class="token punctuation">(</span>branch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>match<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
  <span class="token comment">// 传入数据，渲染为 html字符串</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token attr-name">data</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span>
  
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="渲染同构"><a href="#渲染同构" class="header-anchor">#</a> 渲染同构</h2> <p>假设我们现在基于上面已经实现的代码，同时我们也使用了 webpack 进行了配置，对代码进行了转换和打包，整个服务可以跑起来。</p> <p>路由能够正确匹配，数据预取正常，服务端可以直出组件的 html，浏览器加载 js 代码正常，查看网页源代码能看到 html 内容，好像我们整个流程都已经走完了。</p> <p>但是当浏览器端的 js 执行完成后，发现数据重新请求了，组件的重新渲染导致页面看上去有些闪烁。</p> <p>这是因为在浏览器端，双端节点对比失败，导致组件重新渲染，也就是只有服务端和浏览器端渲染的组件具有相同的 props 和 DOM 结构的时候，组件才能只渲染一次。</p> <p>刚刚我们实现了双端的数据预取同构，但是数据也仅仅是服务端有，浏览器端并没有获取到这份数据，当浏览器进行首次组件渲染的时候没有初始化的数据，渲染出的节点和服务端直出的节点不同，导致组件重新渲染。</p> <h3 id="数据注水"><a href="#数据注水" class="header-anchor">#</a> 数据注水</h3> <blockquote><p>在服务端将预取的数据注入到浏览器，使浏览器可以访问到，客户端进行渲染前将数据传入对应的组件即可，这样就保证了 props 的一致。</p></blockquote> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// node server</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">rea<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
  <span class="token keyword">if</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  
  <span class="token comment">// 查找组件</span>
  <span class="token keyword">const</span> branch <span class="token operator">=</span> <span class="token function">matchRoutes</span><span class="token punctuation">(</span>routes<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
  <span class="token comment">// 得到组件</span>
  <span class="token keyword">const</span> Component <span class="token operator">=</span> branch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>route<span class="token punctuation">.</span>component
  <span class="token comment">// 数据预取</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> Component<span class="token punctuation">.</span><span class="token function">getInitialProps</span><span class="token punctuation">(</span>branch<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>match<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
  <span class="token comment">// 组件渲染</span>
  <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">renderToString</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token attr-name">data</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">)</span>
  <span class="token comment">// 数据注水</span>
  <span class="token keyword">const</span> propsData <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;textarea style=&quot;display: none&quot; id=&quot;server-render-data-BOX&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/textarea&gt;</span><span class="token template-punctuation string">`</span></span>
  <span class="token comment">// 通过 ejs 模版引擎将数据注入到页面</span>
  ejs<span class="token punctuation">.</span><span class="token function">renderFile</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    htmlContent<span class="token operator">:</span> html<span class="token punctuation">,</span>
    propsData
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 渲染数据的key：对应到了ejs中的index</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- node ejs html --&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ie=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>rootEle<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
        &lt;%- htmlContent %&gt; <span class="token comment">&lt;!-- 组件 html 内容 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    
    &lt;%- propsData %&gt; <span class="token comment">&lt;!-- 组件 init state ，现在是个字符串 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>需要借助 ejs 模版，将数据绑定到页面上。</p> <h3 id="数据脱水"><a href="#数据脱水" class="header-anchor">#</a> 数据脱水</h3> <p>上一步数据已经注入到了浏览器端，这一步要在客户端组件渲染前先拿到数据，并且传入组件就可以了。</p> <p>客户端可以直接使用 <code>id=server-render-data-BOX</code> 进行数据获取</p> <p><strong>第一个方法</strong>简单粗暴，直接在组件构造函数进行获取，后续可以使用高阶组件复用这部分逻辑</p> <p><strong>第二个方法</strong>可以通过 context 传递，只需要在入口处传入，在组件中声明 static contextType 即可，这种方法有利于后续引入 redux。</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 定义 context生产者 组件</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> RootContext <span class="token keyword">from</span> <span class="token string">'./route-context'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">RootContext.Provider</span></span> <span class="token attr-name">value</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>initialData <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    	</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">RootContext.Provider</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 入口 app.js</span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserRouter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-router-dom'</span>
<span class="token keyword">import</span> Routes <span class="token keyword">from</span> <span class="token string">'../.'</span>
<span class="token keyword">import</span> Provider <span class="token keyword">from</span> <span class="token string">'./provider'</span>

<span class="token comment">// 渲染入口 接收脱水数据</span>
<span class="token keyword">function</span> <span class="token function">renderUI</span><span class="token punctuation">(</span><span class="token parameter">initialData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ReactDOM<span class="token punctuation">.</span><span class="token function">hydrate</span><span class="token punctuation">(</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    	</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Provider</span></span> <span class="token attr-name">initialData</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>initialData<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
      	</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Routes</span></span><span class="token punctuation">/&gt;</span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Provider</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">BrowserRouter</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 函数执行入口</span>
<span class="token keyword">function</span> <span class="token function">entryIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token constant">APP_INIT_DATA</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token comment">// 取得数据</span>
  <span class="token keyword">let</span> stateText <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'server-render-data-BOX'</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>stateText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">APP_INIT_DATA</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>stateText<span class="token punctuation">.</span>value <span class="token operator">||</span> <span class="token string">'{}'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">APP_INIT_DATA</span><span class="token punctuation">)</span> <span class="token function">renderUI</span><span class="token punctuation">(</span><span class="token constant">APP_INIT_DATA</span><span class="token punctuation">)</span> <span class="token comment">// 客户端渲染</span>
<span class="token punctuation">}</span>

<span class="token function">entryIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 入口执行</span>
</code></pre></div><p>通过 context 获取数据</p> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> <span class="token string">'../css/index.scss'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> context<span class="token punctuation">)</span>
    
    <span class="token comment">// 将 context 存储到 state</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>context
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 设置此参数，才能拿到 context 数据</span>
  <span class="token keyword">static</span> contextType <span class="token operator">=</span> RootContext

  <span class="token comment">// 数据预取方法</span>
	<span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">getInitialProps</span><span class="token punctuation">(</span><span class="token parameter">opt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>__SERVER__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是服务端渲染，可以做的处理，node 端设置全局变量</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> fetch1 <span class="token operator">=</span> fetch<span class="token punctuation">.</span><span class="token function">postForm</span><span class="token punctuation">(</span><span class="token string">'/xxx1'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> fetch2 <span class="token operator">=</span> fetch<span class="token punctuation">.</span><span class="token function">postForm</span><span class="token punctuation">(</span><span class="token string">'/xxx2'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> resArr <span class="token operator">=</span> <span class="token keyword">await</span> fetch<span class="token punctuation">.</span><span class="token function">multipleFetch</span><span class="token punctuation">(</span>fetch1<span class="token punctuation">,</span> fetch2<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      page<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      fetchData<span class="token operator">:</span> resArr
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

	<span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isSSR<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 非服务端渲染需要自身进行数据获取</span>
      Index<span class="token punctuation">.</span><span class="token function">getInitialProps</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>opt<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
    
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> page<span class="token punctuation">,</span> fetchData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state
    <span class="token keyword">const</span> <span class="token punctuation">[</span> res <span class="token punctuation">]</span> <span class="token operator">=</span> fetchData <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>res <span class="token operator">&amp;&amp;</span> res<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">key</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>id<span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre></div><h3 id="css-过滤"><a href="#css-过滤" class="header-anchor">#</a> CSS 过滤</h3> <p>我们在写组件的时候大部分都会导入相关的 css 文件，但是 css 文件无法在服务端执行，所以我们需要在服务端渲染的时候将导入的 css 文件去除掉</p> <h1 id="动态路由"><a href="#动态路由" class="header-anchor">#</a> 动态路由</h1> <blockquote><p>在 SPA 模式下，大部分应用都会实现组件分包和按需加载，为了防止所有代码打包在一个文件，导致资源过大影响页面的加载和渲染。</p> <p>在 SSR 下，我们限定按需的粒度是路由级别，请求不同的路由动态加载对应的组件。</p></blockquote> <h2 id="如何实现组件的按需加载"><a href="#如何实现组件的按需加载" class="header-anchor">#</a> 如何实现组件的按需加载？</h2> <p>在 webpack 2 时期主要是用 require.ensure 方法来实现，在当下 webpack 4，有了更加规范的方式实现按需加载，那就是 <code>import('xx.js')</code>。</p> <p>我们都知道 import 方法传入一个 js 文件地址，返回值是一个 promise 对象，然后再回调中得到按需的组件。它的原理其实就是通过 jsonp 的方式，动态请求脚本，然后在回调内得到组件。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../index'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// xxx</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>所以我们得到了几个比较有用的信息：</p> <ul><li>如何加载脚本：import 结合 webpack 自动完成；</li> <li>脚本是否加载完成：通过 then 方法回调进行处理；</li> <li>获取异步按需组件：通过 then 方法回调获取。</li></ul> <div class="language-jsx extra-class"><pre class="language-jsx"><code><span class="token comment">// 使用 react-loadable </span>
<span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span>
<span class="token keyword">import</span> Loadable <span class="token keyword">from</span> <span class="token string">'react-loadable'</span>

<span class="token comment">// index.js</span>
<span class="token keyword">class</span> <span class="token class-name">Index</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">index</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// detail.js</span>
<span class="token keyword">class</span> <span class="token class-name">Detail</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text">detail</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// route.js</span>
<span class="token comment">// 按需加载 index 组件</span>
<span class="token keyword">const</span> <span class="token function-variable function">AsyncIndex</span> <span class="token operator">=</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Async</span></span> <span class="token attr-name">load</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../index'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  	</span><span class="token punctuation">{</span><span class="token parameter"><span class="token constant">C</span></span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">C</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Async</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token comment">// 按需加载 detail 组件</span>
<span class="token keyword">const</span> <span class="token function-variable function">AsyncDetail</span> <span class="token operator">=</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Async</span></span> <span class="token attr-name">load</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../detail'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
  	</span><span class="token punctuation">{</span><span class="token parameter"><span class="token constant">C</span></span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">C</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">props</span><span class="token punctuation">}</span></span> <span class="token punctuation">/&gt;</span></span><span class="token punctuation">}</span><span class="token plain-text">
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">Async</span></span><span class="token punctuation">&gt;</span></span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> routes <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
    exact<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> AsyncIndex<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    path<span class="token operator">:</span> <span class="token string">'/detail'</span><span class="token punctuation">,</span>
    exact<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    component<span class="token operator">:</span> AsyncDetail
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>按照这种方式进行配置，会发现 ssr 无效了。</p> <h2 id="动态路由-ssr-双端配置"><a href="#动态路由-ssr-双端配置" class="header-anchor">#</a> 动态路由 SSR 双端配置</h2> <p>ssr 无效的原因：</p> <p>因为我们做路由同构的时候，双端使用的是同一个 route 配置文件 routes-config.js，现在组件修改成了按需加载，所以在路由查找后得到的组件发生了改变，AsyncDetail 和 AsyncIndex 无法转换出组件内容。</p> <h3 id="ssr-模式下服务端如何处理路由按需加载"><a href="#ssr-模式下服务端如何处理路由按需加载" class="header-anchor">#</a> ssr 模式下服务端如何处理路由按需加载</h3> <p>参考客户端的处理方式，对路由配置二次处理，服务端在组件查找前强制指向 import 方法，得到一个全新的静态路由表，然后再去查找组件。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> routes <span class="token keyword">from</span> <span class="token string">'routes-config.js'</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getStaticRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> staticRoutes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  
 	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">const</span> route <span class="token keyword">of</span> routes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    staticRoutes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token operator">...</span>route<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
      component<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">await</span> item<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default
    <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> staticRoutes
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ssr-模式下客户端如何处理路由按需加载"><a href="#ssr-模式下客户端如何处理路由按需加载" class="header-anchor">#</a> ssr 模式下客户端如何处理路由按需加载</h3> <p>完成服务端配置后，浏览器会一直显示加载中，这是因为双端节点对比失败，重新渲染。</p> <h4 id="解决办法"><a href="#解决办法" class="header-anchor">#</a> 解决办法</h4> <p>等待按需组件加载完成后再进行渲染。</p> <h4 id="如何按需"><a href="#如何按需" class="header-anchor">#</a> 如何按需</h4> <p>参考服务端设置，不过不转换成静态路由表，只需要找到按需加载组件完成动态加载即可。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/FE-Essay/框架/什么是多态.html" class="prev">
        什么是多态.md
      </a></span> <span class="next"><a href="/FE-Essay/框架/深入react技术栈/一.html">
        一.md
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/FE-Essay/assets/js/app.d894750d.js" defer></script><script src="/FE-Essay/assets/js/2.6f24bad2.js" defer></script><script src="/FE-Essay/assets/js/138.071df325.js" defer></script>
  </body>
</html>
